<template>
    <div class="page page-pd page-console">
        <div class="page-content">
			<div class="container">
				<div class="row">
					<div class="col-100 small-100 medium-100 large-100 xlarge-25"></div>
					<div class="col-100 small-100 medium-100 large-100 xlarge-75">
						<h1>${author.name}</h1>
					</div>
				</div>
			</div>
			<div class="whitebg">
				<div class="container">
					<div class="row">
						<div class="col-50">
							<form class="userforms" id="dataAuthor" name="dataAuthor">
								<div class="flexzone">
									<div>
										<div class="name">Author name</div>
									</div>
									<div class="parms">
										<input class="input" type="text" name="name" placeholder="Helen Ivanova" value="${author.name}"/>
									</div>
								</div>
								<div class="flexzone">
									<div>
										<div class="name">Author Type</div>
									</div>
									<div class="parms">
										<a class="item-link smart-select smart-select-init smartselect-type" data-open-in="popup" data-searchbar="true" data-searchbar-placeholder="Search type aythor">
											<select class="" name="type">
												${typelist.map((item) => $h`
													<option value="${item.id}">${item.name}</option>
												`)}
											</select>
											<div class="item-content">
												<div class="item-inner">
													<div class="item-title">Type list</div>
												</div>
											</div>
										</a>
									</div>
								</div>
								
								<div class="flexzone" style="flex-direction: column;">
									<div style="width: 100%;">
										<div class="name">Author information</div>
									</div>
									<div class="parms" style="width: 100%;">
										<div class="item-input-wrap">
											<div class="text-editor text-editor-init aboutauthor" data-placeholder="Tell about the author">
												<div class="text-editor-content" innerHTML=${author.biography} contenteditable></div>
											</div>
										</div>
									</div>
								</div>
								<div class="flexzone">
									<div>
										<div class="name">Show in author list</div>
									</div>
									<div class="parms">
										<div class="toggleflexColl">
											<div class="toggleflex">
												<div class="nametoggle">Show in author list</div>
												<label class="toggle toggle-init color-blue showlist">
													<input class="" name="showlist" value="1" type="checkbox" ${author.showlist == '1' && $h` checked `}/>
													<span class="toggle-icon"></span>
												</label>
											</div>
										</div>										
									</div>
								</div>
								<div class="flexzone">
									<div>
										<div class="name">Phone</div>
									</div>
									<div class="parms">
										<input class="input" type="text" name="phone" placeholder="0079998887766" value="${author.phone}"/>
									</div>
								</div>
								<div class="flexzone">
									<div>
										<div class="name">Twitter nickname</div>
									</div>
									<div class="parms">
										<input class="input" type="text" name="twitter" placeholder="durov" value="${author.twitter}"/>
									</div>
								</div>
								<div class="flexzone">
									<div>
										<div class="name">Linkedin nickname</div>
									</div>
									<div class="parms">
										<input class="input" type="text" name="linkedin" placeholder="durov" value="${author.linkedin}"/>
									</div>
								</div>
								<div class="flexzone">
									<div>
										<div class="name">Contact email</div>
									</div>
									<div class="parms">
										<input class="input" type="email" name="email" placeholder="mail@gmail.com" value="${author.email}"/>
									</div>
								</div>
								<div class="flexzone">
									<div>
										<div class="name">Personal site</div>
									</div>
									<div class="parms">
										<input class="input" type="text" name="site" placeholder="https://google.com" value="${author.site}"/>
									</div>
								</div>
								<div class="flexzone">
									<div>
										<div class="name">Industry tags</div>
									</div>
									<div class="parms">
										<a class="item-link smart-select smart-select-init smartselect-industry" data-open-in="popup" data-searchbar="true" data-searchbar-placeholder="Search industry">
											<select class="" name="industry" multiple>
												${industrylist.map((item) => $h`
													<option value="${item.id}">${item.name}</option>
												`)}
											</select>
											<div class="item-content">
												<div class="item-inner">
													<div class="item-title">Industry list</div>
												</div>
											</div>
										</a>
									</div>
								</div>
								<div class="flexzone">
									<div>
										<div class="name">Goal tags</div>
									</div>
									<div class="parms">
										<a class="item-link smart-select smart-select-init smartselect-goal" data-open-in="popup" data-searchbar="true" data-searchbar-placeholder="Search goal">
											<select name="goal" multiple>
												<optgroup label="goal">
												${goallist.map((item) => $h`
													<option value="${item.id}">${item.name}</option>
												`)}
												</optgroup>
											</select>
											<div class="item-content">
												<div class="item-inner">
													<div class="item-title">Goal list</div>
												</div>
											</div>
										</a>
									</div>
								</div>
								
								<div class="flexzone">
									<div>
										<div class="name">Social media tags</div>
									</div>
									<div class="parms">
										<a class="item-link smart-select smart-select-init smartselect-socialmedia" data-open-in="popup" data-searchbar="true" data-searchbar-placeholder="Search social media">
											<select name="socialmedia" multiple>
												<optgroup label="socialmedia">
												${socialmedialist.map((item) => $h`
													<option value="${item.id}">${item.name}</option>
												`)}
												</optgroup>
											</select>
											<div class="item-content">
												<div class="item-inner">
													<div class="item-title">Social media list</div>
												</div>
											</div>
										</a>
									</div>
								</div>
								<div class="flexzone">
									<div>
										<div class="name">Tone of voice tags</div>
									</div>
									<div class="parms">
										<a class="item-link smart-select smart-select-init smartselect-tonesvoice" data-open-in="popup" data-searchbar="true" data-searchbar-placeholder="Search Tone of voice">
											<select name="tonesvoice" multiple>
												<optgroup label="tonesvoice">
												${tonesvoicelist.map((item) => $h`
													<option value="${item.id}">${item.name}</option>
												`)}
												</optgroup>
											</select>
											<div class="item-content">
												<div class="item-inner">
													<div class="item-title">Social media list</div>
												</div>
											</div>
										</a>
									</div>
								</div>
								
								<div class="flexzone">
									<div>
										<div class="name">Brands</div>
									</div>
									<div class="parms">
										<a class="item-link smart-select smart-select-init smartselect-brand" data-open-in="popup" data-searchbar="true" data-searchbar-placeholder="Brands">
											<select name="brands" multiple>
												<optgroup label="brands">
												${brandslist.map((item) => $h`
													<option value="${item.id}">${item.name}</option>
												`)}
												</optgroup>
											</select>
											<div class="item-content">
												<div class="item-inner">
													<div class="item-title">Brands</div>
												</div>
											</div>
										</a>
									</div>
								</div>


								<div class="flexzone">
									<div>
										<div class="name"></div>
									</div>
									<div class="parms">
										<a href="#" class="col button button-fill" @click=${saveDataAuthor}>Save data</a>
									</div>
								</div>
							</form>					
						</div>
						<div class="col-25">
						</div>
						<div class="col-25">						
							<div class="rightnav">
								<div class="rightnav">
								<div>
									<a href="/console/authors" class="col button button-fill color-gray">Back to Authors</a>
								</div>
								<div>
									<div class="subtitle">Author's photo</div>
									<form class="list" id="loadPhoto">
										<input type="number" name="id" value="${author.id}" class="hide"/>
										<div class="authorphoto" style="background-image: url(authorsphoto/600/${author.photo}.webp);"></div>
										<div class="hover">
											<div class="flex">
												<p class="p-lg">Click and select a logo to upload</p>
												<span>Image size no more than 5000x5000 and no more than 10MB</span>
												<input class="form-control" type="file" id="photo" accept="image/png, image/jpeg" name="photo"/>
											</div>
										</div>
									</form>

								</div>
								<div>
									<div class="subtitle">Book covers</div>
									<form class="list" id="loadBookcovers">
										<input type="number" name="id" value="${author.id}" class="hide"/>
										<div class="bookcovers"></div>
										<div class="hover active">
											<div class="flex">
												<p class="p-lg">Click and select a book covers to upload</p>
												<span>Image size no more than 5000x5000 and no more than 10MB</span>
												<input class="form-control" type="file" id="bookcovers" name="bookcovers[]" multiple accept="image/png, image/jpeg"/>
											</div>
										</div>
									</form>
									<div class="row">
										${bookcovers.map((item, index) => $h`
										<div class="col-50">
											<a class="showGal" href="#" @click=${showBookcovers} data-gallery="${index}"><img class="noclick" src="bookcovers/200/${item}.webp" style="width: 100%;"/></a>
										</div>
										`)}
									</div>

								</div>
							</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			
        </div>
    </div>
</template>

<script>
export default (props, { $f7, $f7router, $el, $update, $on, $onBeforeMount, $onMounted, $onBeforeUpdate, $onUpdated, $onBeforeUnmount, $onUnmounted, $store, $context}) => {
	var author = {};
	let industrylist = [];
	let goallist = [];
	
	let socialmedialist = [];
	let tonesvoicelist = [];
	
	let typelist = [];
	let brandslist = [];
	let bookcovers = [];
	let contestGallery;
	
	function showBookcovers(e){
		indexImg = $(e.target).attr('data-gallery');
		console.log(indexImg);
		contestGallery.open();
	}
	function uploadPhoto(){

	}
	function saveDataAuthor(){
		var formData = $f7.form.convertToData('#dataAuthor');
		var biography = app.textEditor.get('.aboutauthor');		
		formData['id'] = props.id;
		formData['biography'] = biography.value;
		console.log(formData);
		app.request.postJSON(apiServer+'console/author/save', formData).then(function (res) {
			if(res.data){
				if(res.data.error){
					app.preloader.hide();
					$store.dispatch('msgalert', {err: res.data.error});
				} else {
					app.preloader.hide();
					$store.dispatch('msgalert', {err: 'Information saved'});
					app.views.main.router.refreshPage();
					setTimeout(function () {
						$f7.dialog.close();
					}, 1000);									
				}
								
			} else {
				app.preloader.hide();
				$store.dispatch('msgalert', {err: 'Техническая ошибка. Попробуйте позже.'});
			}
							
		});
	}
	function loadAuthorData(){
		app.request.postJSON(apiServer+'console/author/info', {id: props.id}).then(function (res) {
			if(res.data){
				if(res.data.error){
					app.preloader.hide();
					$store.dispatch('msgalert', {err: res.data.error});
					//app.views.main.router.navigate('/login');
					window.location.href = '/';
				} else {
					author = res.data;
					showlist = app.toggle.get('#dataAuthor .showlist');
					
					if(author.showlist == 1){
						showlist.toggle();
					}
					type = author.type;
					app.smartSelect.get("#dataAuthor .smartselect-type").setValue(type);
					industry = author.industry;
					app.smartSelect.get("#dataAuthor .smartselect-industry").setValue(industry);
					goal = author.goal;
					app.smartSelect.get("#dataAuthor .smartselect-goal").setValue(goal);
					socialmedia = author.socialmedia;
					app.smartSelect.get("#dataAuthor .smartselect-socialmedia").setValue(socialmedia);
					tonesvoice = author.tonesvoice;
					app.smartSelect.get("#dataAuthor .smartselect-tonesvoice").setValue(tonesvoice);
					
					brand = author.brand;
					app.smartSelect.get("#dataAuthor .smartselect-brand").setValue(brand);
					bookcovers = author.bookcovers;
					
					contestGalleryArray = [];
					bookcovers.forEach(function(item, index, array) {
						console.log("bookcovers/1200/"+item+".webp");
						contestGalleryArray.push("bookcovers/1200/"+item+".webp");
					});
					contestGallery = $f7.photoBrowser.create({
						photos: contestGalleryArray,
						theme: 'dark'
					});

					$update();


					app.preloader.hide();
				}
			} else {
				app.preloader.hide();
				$store.dispatch('msgalert', {err: 'Попробуйте позже.'});
			}
		});
	}
	$on("pageInit", function (e, page) {
		var textEditor = app.textEditor.create({
			el: '.aboutauthor',
			buttons: [
				['bold', 'orderedList', 'unorderedList', 'link', 'paragraph'], ['indent', 'outdent'],
			]
		});
		app.request.postJSON(apiServer+'console/list/all').then(function (res) {
			if(res.data){
				if(res.data.err){
					$store.dispatch('msgalert', {err: res.data.err});
				} else {
					authors = res.data.authors;
					tonesvoicelist = res.data.tonesvoice;
					socialmedialist = res.data.socialmedia;
					goallist = res.data.goal;
					industrylist = res.data.industry;
					tagslist = res.data.tags;
					typelist = res.data.type;
					brandslist = res.data.brands;
					$update();
					loadAuthorData();
				}
			} else {
				$store.dispatch('msgalert', {err: 'Попробуйте позже.'});
			}
		});
		
		$('#loadPhoto #photo').change(function() {
			app.dialog.preloader('Пожалуйста, подождите...');
			var formData = $f7.form.convertToData('#loadPhoto');
			var $input = $("#loadPhoto #photo");
			var formData = new FormData;
			formData.append('photo', $input.prop('files')[0]);
			formData.append('id', props.id);

			app.request({
				url: apiServer+'console/author/save',
				method: 'POST',
				data: formData,
				cache: false,
				mimeType: 'multipart/form-data',
				processData: true,
				beforeSend: function ( xhr ) {					
				},
				complete() {
					app.views.main.router.refreshPage();
					app.dialog.close();
				}
			});
		});
		
		$('#loadBookcovers #bookcovers').change(function() {
			$input = $("#loadBookcovers #bookcovers");
			if (parseInt($input.prop('files').length) > 5){
				$store.dispatch('msgalert', {err: 'Неболее 5 файлов за одну загруку.'});
				return;
			};
			
			app.dialog.preloader('Пожалуйста, подождите...');

			formElement = document.querySelector("#loadBookcovers");
			formData = new FormData(formElement);
			formData.append('id', props.id);
			
			app.request({
				url: apiServer+'console/author/save',
				method: 'POST',
				data: formData,
				cache: false,
				mimeType: 'multipart/form-data',
				processData: true,
				beforeSend: function ( xhr ) {					
				},
				complete() {
					app.views.main.router.refreshPage();
					app.dialog.close();
				}
			});
		});

		//app.views.main.router.navigate('/admin/editpost/'+res.data+'/');
	});
    return $render;
}
</script>